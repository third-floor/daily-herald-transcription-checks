<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<title>Transcription Validation</title>

<style>
body { margin: 0; font-family: Arial; background: #f4f4f4; }
.container { display: flex; padding: 20px; gap: 20px; }
.left-panel { width: 40%; display: flex; flex-direction: column; gap: 20px; }
.image-box img { width: 100%; border-radius: 4px; cursor: zoom-in; }
.right-panel { width: 60%; background: white; padding: 20px; border-radius: 8px; }
textarea { width: 100%; height: 80px; }
button { padding: 10px 20px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer; }

/* Progress bar */
#progress-container {
  width: 100%;
  background: #ddd;
  height: 12px;
  border-radius: 6px;
  margin-bottom: 10px;
}
#progress-bar {
  height: 100%;
  width: 0%;
  background: #007acc;
  border-radius: 6px;
}

/* Metadata styling */
#metadata-box {
  background: #eef4ff;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 15px;
  line-height: 1.4em;
}
#metadata-box b {
  color: #003c74;
}

/* Fullscreen */
#fullscreenModal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.95);
  justify-content:center;
  align-items:center;
  z-index:999;
}
#fullscreenModal img {
  max-width:95%;
  max-height:95%;
}
</style>
</head>

<body>

<div id="fullscreenModal" onclick="closeFullscreen()">
    <img id="fullscreenImg">
</div>

<div class="container">

    <div class="left-panel">
        <div class="image-box"><img id="img1" onclick="openFullscreen('img1')"></div>
        <div class="image-box"><img id="img2" onclick="openFullscreen('img2')"></div>
    </div>

    <div class="right-panel">

        <h2>
          Entry <span id="entry-number"></span>  
          <span style="float:right;" id="progress-text"></span>
        </h2>

        <div id="progress-container"><div id="progress-bar"></div></div>

        <!-- NEW: Metadata block -->
        <div id="metadata-box"></div>

        <h3>AI Transcription</h3>
        <div id="aiTranscription" style="white-space:pre-wrap;background:#eee;padding:10px;"></div>

        <h3>Validation</h3>
        <label><input type="radio" name="correctness" value="true"> Transcription is correct</label><br>
        <label><input type="radio" name="correctness" value="false"> Transcription is not correct</label>

        <h3>Comment</h3>
        <textarea id="comment"></textarea>

        <h3>Corrected Transcription</h3>
        <textarea id="correctedText"></textarea>

        <button onclick="submitResponse()">Submit</button>
        <button onclick="skipEntry()">Skip</button>

    </div>

</div>

<script>
// ---------------------------------------
// CONFIG
// ---------------------------------------
const GOOGLE_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxaoGIc1cyrJe79sKLgHENBiHBQyT6p3hbfrZLj3xhobyONBHZgh9teHpSuTtHDGRKt/exec";
const SECRET_TOKEN = "X4p9FJ83kf2AqxZ91mY7BQ2";
const BATCH_SIZE = 50;

let entries = [];
let currentIndex = 0;


// ---------------------------------------
// Load dataset
// ---------------------------------------
async function loadData() {
    const response = await fetch("data.json");
    const json = await response.json();

    entries = json.filter(e => !e.completed).slice(0, BATCH_SIZE);

    loadEntry(0);
}


// ---------------------------------------
// Load an entry (includes metadata + images)
// ---------------------------------------
function loadEntry(i) {
    currentIndex = i;
    const entry = entries[i];

    document.getElementById("entry-number").innerText = entry.id;

    // -----------------------------
    // LOAD METADATA
    // -----------------------------
    const objectUrl = `https://collection.sciencemuseumgroup.org.uk/objects/${entry.col1}`;

    const metadataHTML = `
        <div><b>UID:</b> ${entry.col1} &nbsp; 
             <a href="${objectUrl}" target="_blank">(open object page)</a></div>
        <div><b>Identifier:</b> ${entry.col2}</div>
        <div><b>Title:</b> ${entry.col3}</div>
        <div><b>Description:</b> ${entry.col4}</div>
        <div><b>Category:</b> ${entry.col5}</div>
        <div><b>Material:</b> ${entry.col6}</div>
        <div><b>Object Name:</b> ${entry.col7}</div>
        <div><b>Date:</b> ${entry.col8}</div>
        <div><b>Place:</b> ${entry.col9}</div>
        <div><b>Maker:</b> ${entry.col10}</div>
        <div><b>Image filename:</b> ${entry.col11}</div>
    `;

    document.getElementById("metadata-box").innerHTML = metadataHTML;

    // -----------------------------
    // IMAGES
    // -----------------------------
    document.getElementById("img1").src = entry.link;
    document.getElementById("img2").src = entry.link_large;

    // -----------------------------
    // TRANSCRIPTION
    // -----------------------------
    document.getElementById("aiTranscription").innerText = entry.transcription_ai;

    // -----------------------------
    // Progress
    // -----------------------------
    updateProgress();
}


// ---------------------------------------
// Progress Bar
// ---------------------------------------
function updateProgress() {
    const total = entries.length;
    const remaining = total - currentIndex;
    const percent = Math.round((currentIndex / total) * 100);

    document.getElementById("progress-text").innerText =
      `${remaining} of ${total} remaining`;

    document.getElementById("progress-bar").style.width = percent + "%";
}


// ---------------------------------------
// Fullscreen Image
// ---------------------------------------
function openFullscreen(id) {
    document.getElementById("fullscreenImg").src =
      document.getElementById(id).src;
    document.getElementById("fullscreenModal").style.display = "flex";
}
function closeFullscreen() {
    document.getElementById("fullscreenModal").style.display = "none";
}


// ---------------------------------------
// Submit response
// ---------------------------------------
async function submitResponse() {
    const entry = entries[currentIndex];
    const correctness = document.querySelector("input[name='correctness']:checked");

    if (!correctness) { alert("Select correctness first."); return; }

    const payload = {
        secret: SECRET_TOKEN,
        entry_id: entry.id,
        user_id: localStorage.getItem("user_id") || "anon",
        correct: correctness.value,
        comment: document.getElementById("comment").value,
        corrected_transcription: document.getElementById("correctedText").value
    };

    fetch(GOOGLE_WEBAPP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
    });

    nextEntry();
}

function skipEntry() { nextEntry(); }

function nextEntry() {
    if (currentIndex + 1 < entries.length) {
        loadEntry(currentIndex + 1);
    } else {
        alert("Batch completed!");
    }
}

loadData();
</script>

</body>
</html>
